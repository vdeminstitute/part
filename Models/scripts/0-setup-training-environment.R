#
#   Setup training environment
#   2019-02-20
#
#   Run this before trying to train a model; this sets up the globals and
#   data.
#

library(tidyverse)
library(dplyr)
library(readr)
library(mlr)
library(glmnet)
library(here)
library(MLmetrics)
library(pROC)
library(xtable)
library(parallelMap)
library(e1071)
library(doParallel)
library(states)

setwd(here::here("Models"))

# which year to forecast for?
TARGET_YEAR <- 2021
# test forecast years
TEST_FORECAST_YEARS <- 2011:2019  # this should be one less than TARGET_YEAR
                                  # because any_neg_change_2yr looks ahead at
                                  # next year, but we don't know what
                                  # any_neg_change in
TARGET <- "any_neg_change_2yr"

# Model training settings
CV_REPS       <- 2L
CV_FOLDS      <- 7L
TUNE_CV_FOLDS <- 7L
# How many samples to take for random tune grids?
RANDOM_TUNE_SAMPLES <- 21L
ACC_MEASURES <- list(mlr::brier, mlr::auc, mlr::timeboth)
N_CORES      <- 7L

# Make it parallel ?parallel
if (.Platform$OS.type == "windows") {
  parallelMap::parallelStartSocket(N_CORES)
} else {
  parallelMap::parallelStartMulticore(cpus = N_CORES)
}


#
#   Process data ----
#   __________________

# Country names
data("gwstates")
cnames <- gwstates %>%
  group_by(gwcode) %>%
  dplyr::slice(n()) %>%
  select(gwcode, country_name)

# Complete, non-missing data, except for the TARGET, which will be missing for the
# last year.

complete_data <- read_csv("input/part-v11.csv")
# # take these out from training data
id_cols <- c("gwcode", "year", "country_name", "country_text_id", "country_id",
             "v2x_regime", "v2x_regime_amb", "any_neg_change")

drop_vars <- c("lagged_v2x_regime_asCharacter", "lagged_v2x_regime_asFactor")
dim(complete_data)[2] - length(id_cols) - length(drop_vars)


# Check there are only missing target values in last year
missing_target_by_year <- complete_data %>%
  group_by(year) %>%
  summarize(n = sum(is.na(any_neg_change_2yr)))

# check: only the last 2 years of data should have missing outcomes
miss_years <- missing_target_by_year[missing_target_by_year$n > 0, "year"][[1]]
if (!all(miss_years %in% c(TARGET_YEAR - c(0, 1)))) {
  stop("Something is wrong with missing values in 'any_neg_change_2yr'")
}

# Index for complete training data and forecast data (DV is missing)
train_idx <- complete.cases(complete_data)
fcast_idx <- complete_data$year==max(complete_data$year)

complete_data <- complete_data%>%
  mutate(any_neg_change_2yr = factor(any_neg_change_2yr)) %>%
  # convert hidden discrete vars to dummy
  # NOTE: this does not leave out a reference level; take out intercept in any
  # models that include this feature
  mutate(lagged_v2x_regime = as.factor(lagged_v2x_regime)) %>%
  mlr::createDummyFeatures(., cols = "lagged_v2x_regime")

# Split data; this will be a list containing all the data partitions we
# need for training, out-of-sample eval, etc.
split_data <- list(
  # Training set
  train_ids = complete_data %>% dplyr::filter(train_idx) %>%
    dplyr::select(all_of(id_cols)),
  train     = complete_data %>% dplyr::filter(train_idx) %>%
    dplyr::select(-one_of(id_cols, drop_vars)) %>% as.data.frame(),
  # Forecast data
  fcast_ids = complete_data %>% dplyr::filter(fcast_idx) %>%
    dplyr::select(all_of(id_cols)),
  fcast     = complete_data %>% dplyr::filter(fcast_idx) %>%
    dplyr::select(-one_of(id_cols, drop_vars)) %>% as.data.frame()
)

write_rds(split_data, "output/split-data.rds")

full_task <- makeClassifTask(data = split_data$train,
                             target = "any_neg_change_2yr",
                             positive = "1")



