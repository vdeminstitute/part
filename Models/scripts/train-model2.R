#
#   Model 2: restricted logistic regression
#

warning("add remaining features")

setwd(here::here("Models"))

# to ID output files
model_prefix <- "mdl2"

# Load needed packages and setup global variables controlling model training
source("scripts/0-setup-training-environment.R")
# import functions
source("R/functions.R")


#
#   Setup task and learner
#   ______________________

# Setup model
glm_binomial <- makeLearner("classif.logreg", predict.type = "prob")

# Features to retain
drop <- setdiff(getTaskFeatureNames(full_task),
                c(paste0("lagged_v2x_regime.", 1:3),
                  #"lagged_fpi_real_change",
                  #"lagged_any_conflict",
                  #"lagegd_IT.CEL.SETS.P2",
                  "lagged_state_age", "lagged_pt_coup_attempt_num10yrs"
                  ))
full_task_some_features <- dropFeatures(full_task, drop)


learner <- glm_binomial
task    <- full_task_some_features


#
#   Test forecasts
#   _______________


test_forecasts <- test_forecast(learner, task, TEST_FORECAST_YEARS)
write_rds(test_forecasts, file = sprintf("output/predictions/%s_test_forecasts.rds", model_prefix))


#
#   Live forecast
#   ________________

# Estimate final version of model on full data
mdl_full_data <- mlr::train(learner, task)
write_rds(mdl_full_data, file = sprintf("output/models/%s_full_data.rds", model_prefix))

forecast_data <- split_data$fcast %>% select(-!!TARGET)
fcast <- predict(mdl_full_data, newdata = as.data.frame(forecast_data))

fcast <- bind_cols(split_data$fcast_ids[, c("gwcode", "country_name", "year")],
                   split_data$fcast[, TARGET, drop = FALSE],
                   fcast$data) %>%
  arrange(prob.1)

write_rds(fcast, sprintf("output/predictions/%s_live_forecast.rds", model_prefix))

#
#   Cleanup
#   ________

parallelStop()

lgr$info("Models done, please source assessment script")
